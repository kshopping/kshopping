<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>K-SHOP ê´€ë¦¬ì</title>

  <!-- ê´€ë¦¬ì CSS -->
  <link rel="stylesheet" href="/css/admin.css" />

  <!-- âœ… ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì²´í¬ (ê°€ì¥ ë¨¼ì € ì‹¤í–‰) -->
  <script>
    (function () {
      const adminPass = "100101";
      const okKey = "admin_ok";

      if (sessionStorage.getItem(okKey) !== "true") {
        const input = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");

        if (input !== adminPass) {
          alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          location.replace("/index.html");
          return;
        }
        sessionStorage.setItem(okKey, "true");
      }
    })();
  </script>

  <!-- XLSX (ì—‘ì…€ ì €ì¥ìš©) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- âœ… ê´€ë¦¬ì JS (ì ˆëŒ€ê²½ë¡œë¡œ ìˆ˜ì •ë¨) -->
  <script type="module" src="/js/admin.js"></script>

  <!-- âœ… íŒì—… ê´€ë¦¬ìš© ìŠ¤íƒ€ì¼ (admin.css ê±´ë“œë¦¬ì§€ ì•Šê³  ì—¬ê¸°ì„œ ì¶”ê°€) -->
  <style>
    .popup-admin-wrap {
      max-width: 960px;
      background: #fff;
      border-radius: 14px;
      padding: 22px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    .popup-admin-wrap h2 {
      margin: 0 0 10px;
      font-size: 22px;
    }
    .popup-admin-subtitle{
      font-size: 13px;
      color: #666;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .popup-admin-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: 1fr 1fr;
      margin-top: 16px;
    }
    .popup-admin-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .popup-admin-row label {
      font-weight: 800;
      font-size: 13px;
      color: #222;
    }
    .popup-admin-row input,
    .popup-admin-row select {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
    }
    .popup-admin-row input:focus,
    .popup-admin-row select:focus {
      border-color: #ff4d4f;
      box-shadow: 0 0 0 3px rgba(255,77,79,0.12);
    }

    .popup-admin-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 18px;
    }
    .popup-admin-actions button {
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 900;
      font-size: 14px;
    }
    .btn-primary { background:#ff4d4f; color:#fff; }
    .btn-secondary { background:#222; color:#fff; }
    .btn-ghost { background:#f2f2f2; color:#111; }
    .btn-warn { background:#ffe2e2; color:#a00000; }

    .popup-admin-tip {
      margin-top: 12px;
      padding: 12px;
      background: #fff8e6;
      border: 1px solid #ffe2a8;
      border-radius: 10px;
      color: #7a4b00;
      font-size: 13px;
      line-height: 1.55;
    }

    .popup-admin-preview {
      margin-top: 16px;
      padding: 12px;
      border: 1px dashed #ddd;
      border-radius: 12px;
      background: #fafafa;
      font-size: 13px;
      color: #333;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .popup-admin-switch {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
    }
    .popup-admin-switch input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #ff4d4f;
    }

    .upload-inline {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .upload-inline input[type="file"]{
      padding: 8px;
      border: 1px dashed #ddd;
      border-radius: 10px;
      background: #fff;
      width: 100%;
    }

    .small-note {
      font-size: 12px;
      color: #666;
      line-height: 1.45;
    }

    .img-preview-box{
      margin-top: 8px;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 10px;
      background: #fff;
    }
    .img-preview-box img{
      width: 100%;
      max-width: 360px;
      border-radius: 10px;
      display: block;
    }

    .compression-box{
      margin-top: 12px;
      padding: 12px;
      border: 1px solid #eee;
      border-radius: 12px;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .compression-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .compression-row input[type="range"]{
      width: 240px;
    }
    .badge{
      display:inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: #111;
      color:#fff;
      font-size: 12px;
      font-weight: 900;
    }

    .section-title{
      margin-top: 18px;
      padding-top: 14px;
      border-top: 1px dashed #eee;
      font-size: 15px;
      font-weight: 900;
      color: #111;
    }

    .coupon-preview {
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid #eee;
      padding: 12px;
      background: #fff;
    }
    .coupon-preview .box{
      border-radius: 14px;
      padding: 12px 14px;
      text-align: center;
      font-weight: 900;
      user-select: none;
    }
    .coupon-preview .title{
      font-size: 13px;
      font-weight: 900;
      opacity: 0.95;
      margin-bottom: 6px;
    }
    .coupon-preview .code{
      font-size: 20px;
      letter-spacing: 1px;
    }
    .coupon-preview .sub{
      margin-top: 6px;
      font-size: 12px;
      font-weight: 800;
      opacity: 0.9;
    }

    @media (max-width: 980px) {
      .popup-admin-grid { grid-template-columns: 1fr; }
      .compression-row input[type="range"]{ width: 100%; }
    }
  </style>
</head>

<body>

  <!-- ì‚¬ì´ë“œë°” -->
  <div id="sidebar">
    <button class="home-btn" onclick="location.href='/index.html'">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>

    <h2>ê´€ë¦¬ì ë©”ë‰´</h2>

    <button class="menu-btn" onclick="showPage('products')">ìƒí’ˆ ê´€ë¦¬</button>
    <button class="menu-btn" onclick="showPage('categories')">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</button>
    <button class="menu-btn" onclick="showPage('banners')">ë°°ë„ˆ ê´€ë¦¬</button>
    <button class="menu-btn" onclick="showPage('orders')">ì£¼ë¬¸ ê´€ë¦¬</button>
    <button class="menu-btn" onclick="showPage('printed')">ì¶œë ¥ëœ ì£¼ë¬¸</button>
    <button class="menu-btn" onclick="showPage('account')">ê³„ì¢Œ ì •ë³´</button>
    <button class="menu-btn" onclick="showPage('detailImages')">ìƒì„¸ ì´ë¯¸ì§€ ê´€ë¦¬</button>

    <!-- âœ… NEW: íŒì—… ê´€ë¦¬ ë©”ë‰´ -->
    <button class="menu-btn" onclick="openPopupAdminPage()">ğŸ“£ íŒì—… ê´€ë¦¬</button>
  </div>

  <!-- ë©”ì¸ ì˜ì—­ -->
  <div id="main-area">
    <div id="default-page">
      <h2>K-SHOP ê´€ë¦¬ì í˜ì´ì§€</h2>
      <p>ì™¼ìª½ ë©”ë‰´ì—ì„œ ê´€ë¦¬ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</p>
    </div>
  </div>

  <!-- âœ… íŒì—… ê´€ë¦¬ ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ (admin.jsì™€ ì¶©ëŒ ì—†ì´ ë…ë¦½ ì‹¤í–‰) -->
  <script>
    /* =========================
       íŒì—… ìš´ì˜ ì„¤ì • ì €ì¥ í‚¤
    ========================== */
    const POPUP_CONFIG_KEY = "dealer_popup_config";
    const POPUP_SEEN_KEY = "dealer_popup_seen"; // index.htmlê³¼ ë™ì¼

    /* =========================
       âœ… ìë™ ì••ì¶• ê¸°ë³¸ê°’
    ========================== */
    const imageCompressionConfig = {
      targetKB: 300,
      maxWidth: 900,
      quality: 0.82
    };

    /* =========================
       ê¸°ë³¸ ì„¤ì •ê°’ (ì´ˆê¸°ê°’)
    ========================== */
    const defaultPopupConfig = {
      enabled: false,
      startDate: "2025-01-01",
      endDate: "2026-12-31",
      showOncePerDay: true,
      storageKey: POPUP_SEEN_KEY,

      defaultImage: "images/dealer_popup_select.png",
      langImages: {
        en: "images/dealer_popup_en.png",
        vi: "images/dealer_popup_vi.png",
        th: "images/dealer_popup_th.png",
        id: "images/dealer_popup_id.png"
      },
      clickLink: "",

      coupon: {
        enabled: false,
        title: "ğŸ Coupon",
        code: "WELCOME10",
        sub: "Tap to copy",
        position: "bottom",   // top/middle/bottom
        fontSize: 20,
        bg: true,
        textColor: "#ffffff",
        bgColor: "rgba(0,0,0,0.78)"
      }
    };

    function loadPopupConfig() {
      try {
        const raw = localStorage.getItem(POPUP_CONFIG_KEY);
        if (!raw) return structuredClone(defaultPopupConfig);
        const parsed = JSON.parse(raw);

        const merged = {
          ...structuredClone(defaultPopupConfig),
          ...parsed,
          langImages: {
            ...structuredClone(defaultPopupConfig.langImages),
            ...(parsed.langImages || {})
          },
          coupon: {
            ...structuredClone(defaultPopupConfig.coupon),
            ...(parsed.coupon || {})
          }
        };

        // storageKeyëŠ” ê³ ì •
        merged.storageKey = POPUP_SEEN_KEY;
        return merged;
      } catch (e) {
        return structuredClone(defaultPopupConfig);
      }
    }

    function savePopupConfig(cfg) {
      localStorage.setItem(POPUP_CONFIG_KEY, JSON.stringify(cfg));
    }

    function resetPopupConfig() {
      localStorage.removeItem(POPUP_CONFIG_KEY);
    }

    function clearSeenToday() {
      localStorage.removeItem(POPUP_SEEN_KEY);
    }

    /* =========================
       âœ… ì´ë¯¸ì§€ ë¡œë“œ (íŒŒì¼ -> HTMLImageElement)
    ========================== */
    function loadImageFromFile(file) {
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => {
          URL.revokeObjectURL(url);
          resolve(img);
        };
        img.onerror = (e) => {
          URL.revokeObjectURL(url);
          reject(e);
        };
        img.src = url;
      });
    }

    function canvasToDataURL(canvas, quality) {
      return canvas.toDataURL("image/jpeg", quality);
    }

    function dataURLSizeKB(dataURL) {
      const base64 = dataURL.split(",")[1] || "";
      const bytes = Math.ceil((base64.length * 3) / 4);
      return Math.round(bytes / 1024);
    }

    async function compressImageToDataURL(file, opts) {
      const { targetKB, maxWidth, quality } = opts;

      const img = await loadImageFromFile(file);

      let w = img.width;
      let h = img.height;

      if (w > maxWidth) {
        const ratio = maxWidth / w;
        w = Math.round(w * ratio);
        h = Math.round(h * ratio);
      }

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext("2d");
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";
      ctx.drawImage(img, 0, 0, w, h);

      let q = quality;
      let dataURL = canvasToDataURL(canvas, q);
      let sizeKB = dataURLSizeKB(dataURL);

      let tries = 0;
      while (sizeKB > targetKB && tries < 12) {
        q = Math.max(0.45, q - 0.05);
        dataURL = canvasToDataURL(canvas, q);
        sizeKB = dataURLSizeKB(dataURL);
        tries++;
      }

      return { dataURL, sizeKB, width: w, height: h, quality: q };
    }

    /* =========================
       íŒì—… ê´€ë¦¬ í˜ì´ì§€ ë Œë”
    ========================== */
    function openPopupAdminPage() {
      const main = document.getElementById("main-area");
      if (!main) return;

      const cfg = loadPopupConfig();

      main.innerHTML = `
        <div class="popup-admin-wrap">
          <h2>ğŸ“£ íŒì—… ê´€ë¦¬ (ìš´ì˜ì ëª¨ë“œ)</h2>
          <div class="popup-admin-subtitle">
            âœ… ì—¬ê¸°ì„œ ì €ì¥í•˜ë©´ <b>ë©”ì¸(index.html) íŒì—…ì— ì¦‰ì‹œ ë°˜ì˜</b>ë©ë‹ˆë‹¤.<br>
            âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œëŠ” <b>ìë™ ì••ì¶•(ë¦¬ì‚¬ì´ì¦ˆ+í’ˆì§ˆì¡°ì ˆ)</b>ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.
          </div>

          <div class="popup-admin-tip">
            <b>ìš´ì˜ TIP</b><br>
            - ì´ë²¤íŠ¸ ì‹œì‘: íŒì—… ON + ê¸°ê°„ ì„¤ì • + ì¿ í° ON + ì €ì¥<br>
            - ì´ë²¤íŠ¸ ì¢…ë£Œ: íŒì—… OFF + ì €ì¥ (íŒì—…ì€ ë‚¨ì•„ìˆê³  ì•ˆ ëœ¸)<br>
            - í…ŒìŠ¤íŠ¸: "ì˜¤ëŠ˜ ë‹¤ì‹œ ëœ¨ê²Œ(í…ŒìŠ¤íŠ¸)" ëˆ„ë¥´ê³  ë©”ì¸ ìƒˆë¡œê³ ì¹¨
          </div>

          <div class="compression-box">
            <div class="compression-row">
              <span class="badge">ì••ì¶• ì„¤ì •</span>
              <span class="small-note">ëª©í‘œ ìš©ëŸ‰(KB):</span>
              <input type="range" id="targetKBRange" min="120" max="600" step="10" value="${imageCompressionConfig.targetKB}">
              <b id="targetKBText">${imageCompressionConfig.targetKB} KB</b>
            </div>
            <div class="compression-row">
              <span class="small-note">ìµœëŒ€ ê°€ë¡œ(px):</span>
              <input type="range" id="maxWidthRange" min="600" max="1400" step="50" value="${imageCompressionConfig.maxWidth}">
              <b id="maxWidthText">${imageCompressionConfig.maxWidth}px</b>
            </div>
            <div class="small-note">
              âœ… ì¶”ì²œê°’: <b>300KB / 900px</b> (íŒì—… ì„ ëª… + ë¹ ë¦„)
            </div>
          </div>

          <div class="popup-admin-grid">
            <div class="popup-admin-row">
              <label>íŒì—… ON/OFF</label>
              <div class="popup-admin-switch">
                <input type="checkbox" id="pop_enabled" ${cfg.enabled ? "checked" : ""}>
                <span>${cfg.enabled ? "ON" : "OFF"}</span>
              </div>
            </div>

            <div class="popup-admin-row">
              <label>í•˜ë£¨ 1ë²ˆë§Œ í‘œì‹œ</label>
              <div class="popup-admin-switch">
                <input type="checkbox" id="pop_once" ${cfg.showOncePerDay ? "checked" : ""}>
                <span>${cfg.showOncePerDay ? "ON" : "OFF"}</span>
              </div>
            </div>

            <div class="popup-admin-row">
              <label>ì‹œì‘ì¼ (YYYY-MM-DD)</label>
              <input id="pop_start" value="${cfg.startDate}">
            </div>

            <div class="popup-admin-row">
              <label>ì¢…ë£Œì¼ (YYYY-MM-DD)</label>
              <input id="pop_end" value="${cfg.endDate}">
            </div>

            <!-- âœ… ê¸°ë³¸ ì´ë¯¸ì§€ -->
            <div class="popup-admin-row" style="grid-column: 1 / -1;">
              <label>ê¸°ë³¸ íŒì—… ì´ë¯¸ì§€ URL</label>
              <input id="pop_img_default" value="${escapeHtml(cfg.defaultImage)}">
              <div class="upload-inline">
                <input type="file" id="file_default" accept="image/*">
                <button class="btn-ghost" type="button" onclick="handleUpload('default')">ì—…ë¡œë“œ(ìë™ì••ì¶•)</button>
              </div>
              <div class="img-preview-box" id="preview_default"></div>
              <div class="small-note" id="info_default"></div>
            </div>

            <!-- âœ… ì–¸ì–´ë³„ ì´ë¯¸ì§€ -->
            <div class="popup-admin-row">
              <label>EN ì´ë¯¸ì§€ URL</label>
              <input id="pop_img_en" value="${escapeHtml(cfg.langImages.en)}">
              <div class="upload-inline">
                <input type="file" id="file_en" accept="image/*">
                <button class="btn-ghost" type="button" onclick="handleUpload('en')">ì—…ë¡œë“œ(ìë™ì••ì¶•)</button>
              </div>
              <div class="img-preview-box" id="preview_en"></div>
              <div class="small-note" id="info_en"></div>
            </div>

            <div class="popup-admin-row">
              <label>VI ì´ë¯¸ì§€ URL</label>
              <input id="pop_img_vi" value="${escapeHtml(cfg.langImages.vi)}">
              <div class="upload-inline">
                <input type="file" id="file_vi" accept="image/*">
                <button class="btn-ghost" type="button" onclick="handleUpload('vi')">ì—…ë¡œë“œ(ìë™ì••ì¶•)</button>
              </div>
              <div class="img-preview-box" id="preview_vi"></div>
              <div class="small-note" id="info_vi"></div>
            </div>

            <div class="popup-admin-row">
              <label>TH ì´ë¯¸ì§€ URL</label>
              <input id="pop_img_th" value="${escapeHtml(cfg.langImages.th)}">
              <div class="upload-inline">
                <input type="file" id="file_th" accept="image/*">
                <button class="btn-ghost" type="button" onclick="handleUpload('th')">ì—…ë¡œë“œ(ìë™ì••ì¶•)</button>
              </div>
              <div class="img-preview-box" id="preview_th"></div>
              <div class="small-note" id="info_th"></div>
            </div>

            <div class="popup-admin-row">
              <label>ID ì´ë¯¸ì§€ URL</label>
              <input id="pop_img_id" value="${escapeHtml(cfg.langImages.id)}">
              <div class="upload-inline">
                <input type="file" id="file_id" accept="image/*">
                <button class="btn-ghost" type="button" onclick="handleUpload('id')">ì—…ë¡œë“œ(ìë™ì••ì¶•)</button>
              </div>
              <div class="img-preview-box" id="preview_id"></div>
              <div class="small-note" id="info_id"></div>
            </div>

            <div class="popup-admin-row" style="grid-column: 1 / -1;">
              <label>íŒì—… í´ë¦­ ì´ë™ ë§í¬ (ì„ íƒ)</label>
              <input id="pop_link" placeholder="https://k-shopping.shop/event.html" value="${escapeHtml(cfg.clickLink || "")}">
              <div class="small-note">â€» ì…ë ¥í•˜ë©´ íŒì—… ì´ë¯¸ì§€ í´ë¦­ ì‹œ ìƒˆ ì°½ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</div>
            </div>
          </div>

          <div class="section-title">ğŸ ì¿ í° ì˜¤ë²„ë ˆì´ ì„¤ì •</div>

          <div class="popup-admin-grid">
            <div class="popup-admin-row">
              <label>ì¿ í° í‘œì‹œ ON/OFF</label>
              <div class="popup-admin-switch">
                <input type="checkbox" id="coupon_enabled" ${cfg.coupon.enabled ? "checked" : ""}>
                <span>${cfg.coupon.enabled ? "ON" : "OFF"}</span>
              </div>
              <div class="small-note">â€» ONì´ë©´ íŒì—… ì´ë¯¸ì§€ ìœ„ì— ì¿ í°ì´ ëœ¨ê³ , í´ë¦­í•˜ë©´ ìë™ ë³µì‚¬ë©ë‹ˆë‹¤.</div>
            </div>

            <div class="popup-admin-row">
              <label>ì¿ í° ìœ„ì¹˜</label>
              <select id="coupon_position">
                <option value="top" ${cfg.coupon.position === "top" ? "selected" : ""}>ìƒë‹¨</option>
                <option value="middle" ${cfg.coupon.position === "middle" ? "selected" : ""}>ì¤‘ì•™</option>
                <option value="bottom" ${cfg.coupon.position === "bottom" ? "selected" : ""}>í•˜ë‹¨</option>
              </select>
            </div>

            <div class="popup-admin-row">
              <label>ì¿ í° ì œëª© (ì˜ˆ: ğŸ Coupon / ğŸ ì¿ í°)</label>
              <input id="coupon_title" value="${escapeHtml(cfg.coupon.title)}">
            </div>

            <div class="popup-admin-row">
              <label>ì¿ í° ì½”ë“œ (ë³µì‚¬ë  ê°’)</label>
              <input id="coupon_code" value="${escapeHtml(cfg.coupon.code)}">
            </div>

            <div class="popup-admin-row" style="grid-column: 1 / -1;">
              <label>ì¿ í° ì•ˆë‚´ ë¬¸êµ¬ (ì˜ˆ: Tap to copy)</label>
              <input id="coupon_sub" value="${escapeHtml(cfg.coupon.sub)}">
            </div>

            <div class="popup-admin-row">
              <label>ì½”ë“œ ê¸€ì í¬ê¸°</label>
              <input type="range" id="coupon_fontsize" min="14" max="34" step="1" value="${Number(cfg.coupon.fontSize) || 20}">
              <div class="small-note"><b id="coupon_fontsize_text">${Number(cfg.coupon.fontSize) || 20}px</b></div>
            </div>

            <div class="popup-admin-row">
              <label>ë°°ê²½ ë°•ìŠ¤ ON/OFF</label>
              <div class="popup-admin-switch">
                <input type="checkbox" id="coupon_bg" ${cfg.coupon.bg ? "checked" : ""}>
                <span>${cfg.coupon.bg ? "ON" : "OFF"}</span>
              </div>
            </div>

            <div class="popup-admin-row">
              <label>í…ìŠ¤íŠ¸ ìƒ‰ìƒ</label>
              <input id="coupon_textColor" value="${escapeHtml(cfg.coupon.textColor || "#ffffff")}">
              <div class="small-note">ì˜ˆ: #ffffff</div>
            </div>

            <div class="popup-admin-row">
              <label>ë°°ê²½ ìƒ‰ìƒ (RGBA ì¶”ì²œ)</label>
              <input id="coupon_bgColor" value="${escapeHtml(cfg.coupon.bgColor || "rgba(0,0,0,0.78)")}">
              <div class="small-note">ì˜ˆ: rgba(0,0,0,0.78)</div>
            </div>
          </div>

          <div class="coupon-preview" id="couponPreview">
            <div class="small-note" style="margin-bottom:8px;"><b>ë¯¸ë¦¬ë³´ê¸°</b> (ì €ì¥ ì—†ì´ë„ ì¦‰ì‹œ í™•ì¸ ê°€ëŠ¥)</div>
            <div class="box" id="couponPreviewBox">
              <div class="title" id="couponPreviewTitle">ğŸ Coupon</div>
              <div class="code" id="couponPreviewCode">WELCOME10</div>
              <div class="sub" id="couponPreviewSub">Tap to copy</div>
            </div>
          </div>

          <div class="popup-admin-actions">
            <button class="btn-primary" onclick="popupAdminSave()">ğŸ’¾ ì €ì¥</button>
            <button class="btn-secondary" onclick="popupAdminPreview()">ğŸ‘€ ì„¤ì • JSON ë¯¸ë¦¬ë³´ê¸°</button>
            <button class="btn-ghost" onclick="popupAdminClearSeen()">ğŸ” ì˜¤ëŠ˜ ë‹¤ì‹œ ëœ¨ê²Œ(í…ŒìŠ¤íŠ¸)</button>
            <button class="btn-ghost" onclick="popupAdminReset()">â™»ï¸ ì„¤ì • ì´ˆê¸°í™”</button>
            <button class="btn-warn" onclick="popupAdminHardReset()">ğŸ§¨ íŒì—…+ì¿ í° ì „ì²´ ì´ˆê¸°í™”(ì£¼ì˜)</button>
          </div>

          <div class="popup-admin-preview" id="popupPreviewBox">ì—¬ê¸°ì— í˜„ì¬ ì„¤ì • JSONì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      `;

      bindCompressionControls();
      bindToggleRerender();
      bindCouponLivePreview();
      popupAdminPreview();
      renderImagePreviews();
      refreshCouponPreview();
    }

    function escapeHtml(str){
      if(str === null || str === undefined) return "";
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("\"","&quot;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }

    function bindCompressionControls(){
      const targetRange = document.getElementById("targetKBRange");
      const widthRange = document.getElementById("maxWidthRange");
      const targetText = document.getElementById("targetKBText");
      const widthText = document.getElementById("maxWidthText");

      if(targetRange){
        targetRange.addEventListener("input", ()=>{
          imageCompressionConfig.targetKB = Number(targetRange.value);
          if(targetText) targetText.textContent = imageCompressionConfig.targetKB + " KB";
        });
      }
      if(widthRange){
        widthRange.addEventListener("input", ()=>{
          imageCompressionConfig.maxWidth = Number(widthRange.value);
          if(widthText) widthText.textContent = imageCompressionConfig.maxWidth + "px";
        });
      }
    }

    function bindToggleRerender(){
      const ids = ["pop_enabled","pop_once","coupon_enabled","coupon_bg"];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(el){
          el.addEventListener("change", ()=> openPopupAdminPage());
        }
      });
    }

    function bindCouponLivePreview(){
      const fs = document.getElementById("coupon_fontsize");
      if(fs){
        fs.addEventListener("input", ()=>{
          const t = document.getElementById("coupon_fontsize_text");
          if(t) t.textContent = fs.value + "px";
          refreshCouponPreview();
        });
      }

      const liveIds = [
        "coupon_title","coupon_code","coupon_sub",
        "coupon_position","coupon_textColor","coupon_bgColor"
      ];
      liveIds.forEach(id=>{
        const el = document.getElementById(id);
        if(el){
          el.addEventListener("input", refreshCouponPreview);
          el.addEventListener("change", refreshCouponPreview);
        }
      });
    }

    function refreshCouponPreview(){
      const cfg = popupAdminGetForm();

      const box = document.getElementById("couponPreviewBox");
      const title = document.getElementById("couponPreviewTitle");
      const code = document.getElementById("couponPreviewCode");
      const sub = document.getElementById("couponPreviewSub");

      if(!box || !title || !code || !sub) return;

      title.textContent = cfg.coupon.title || "ğŸ Coupon";
      code.textContent = cfg.coupon.code || "WELCOME10";
      sub.textContent = cfg.coupon.sub || "Tap to copy";
      code.style.fontSize = (Number(cfg.coupon.fontSize) || 20) + "px";

      box.style.color = cfg.coupon.textColor || "#fff";
      if(cfg.coupon.bg){
        box.style.background = cfg.coupon.bgColor || "rgba(0,0,0,0.78)";
      }else{
        box.style.background = "transparent";
        box.style.border = "1px dashed #ddd";
      }

      const wrap = document.getElementById("couponPreview");
      if(wrap){
        wrap.style.opacity = cfg.coupon.enabled ? "1" : "0.4";
      }
    }

    function popupAdminGetForm() {
      const enabled = document.getElementById("pop_enabled")?.checked || false;
      const showOncePerDay = document.getElementById("pop_once")?.checked || false;

      const startDate = (document.getElementById("pop_start")?.value || "").trim();
      const endDate = (document.getElementById("pop_end")?.value || "").trim();

      const defaultImage = (document.getElementById("pop_img_default")?.value || "").trim();
      const en = (document.getElementById("pop_img_en")?.value || "").trim();
      const vi = (document.getElementById("pop_img_vi")?.value || "").trim();
      const th = (document.getElementById("pop_img_th")?.value || "").trim();
      const id = (document.getElementById("pop_img_id")?.value || "").trim();

      const clickLink = (document.getElementById("pop_link")?.value || "").trim();

      const couponEnabled = document.getElementById("coupon_enabled")?.checked || false;
      const couponTitle = (document.getElementById("coupon_title")?.value || "").trim();
      const couponCode = (document.getElementById("coupon_code")?.value || "").trim();
      const couponSub = (document.getElementById("coupon_sub")?.value || "").trim();
      const couponPosition = (document.getElementById("coupon_position")?.value || "bottom").trim();
      const couponFontSize = Number(document.getElementById("coupon_fontsize")?.value || 20);
      const couponBg = document.getElementById("coupon_bg")?.checked || false;
      const couponTextColor = (document.getElementById("coupon_textColor")?.value || "#ffffff").trim();
      const couponBgColor = (document.getElementById("coupon_bgColor")?.value || "rgba(0,0,0,0.78)").trim();

      return {
        enabled,
        startDate,
        endDate,
        showOncePerDay,
        storageKey: POPUP_SEEN_KEY,
        defaultImage,
        langImages: { en, vi, th, id },
        clickLink,
        coupon: {
          enabled: couponEnabled,
          title: couponTitle || "ğŸ Coupon",
          code: couponCode || "WELCOME10",
          sub: couponSub || "Tap to copy",
          position: couponPosition || "bottom",
          fontSize: couponFontSize || 20,
          bg: couponBg,
          textColor: couponTextColor || "#ffffff",
          bgColor: couponBgColor || "rgba(0,0,0,0.78)"
        }
      };
    }

    function popupAdminSave() {
      const cfg = popupAdminGetForm();
      savePopupConfig(cfg);
      alert("âœ… ì €ì¥ ì™„ë£Œ! ë©”ì¸(index.html)ì—ì„œ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.");
      popupAdminPreview();
      renderImagePreviews();
      refreshCouponPreview();
    }

    function popupAdminPreview() {
      const cfg = popupAdminGetForm();
      const box = document.getElementById("popupPreviewBox");
      if (!box) return;
      box.textContent = JSON.stringify(cfg, null, 2);
    }

    function popupAdminClearSeen() {
      clearSeenToday();
      alert("âœ… ì˜¤ëŠ˜ í‘œì‹œ ê¸°ë¡ ì‚­ì œ ì™„ë£Œ!\nì´ì œ ë©”ì¸(index.html) ìƒˆë¡œê³ ì¹¨í•˜ë©´ íŒì—…ì´ ë‹¤ì‹œ ëœ° ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    }

    function popupAdminReset() {
      const ok = confirm("ì •ë§ ì„¤ì •ì„ ì´ˆê¸°í™”í• ê¹Œìš”?\n(ì €ì¥ëœ íŒì—… ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤)");
      if (!ok) return;
      resetPopupConfig();
      alert("âœ… ì´ˆê¸°í™” ì™„ë£Œ! ê¸°ë³¸ê°’ìœ¼ë¡œ ëŒì•„ê°”ìŠµë‹ˆë‹¤.");
      openPopupAdminPage();
    }

    function popupAdminHardReset(){
      const ok = confirm("âš ï¸ ì£¼ì˜!\níŒì—… ì„¤ì • + ì˜¤ëŠ˜í‘œì‹œê¸°ë¡ê¹Œì§€ ì „ë¶€ ì‚­ì œí•©ë‹ˆë‹¤.\nì •ë§ ì§„í–‰í• ê¹Œìš”?");
      if(!ok) return;
      resetPopupConfig();
      clearSeenToday();
      alert("âœ… ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ!");
      openPopupAdminPage();
    }

    async function handleUpload(type) {
      try {
        const fileInput = document.getElementById(`file_${type}`);
        if (!fileInput || !fileInput.files || !fileInput.files[0]) {
          alert("ì—…ë¡œë“œí•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”!");
          return;
        }

        const file = fileInput.files[0];

        const hardLimitBytes = 12 * 1024 * 1024;
        if (file.size > hardLimitBytes) {
          alert("âš ï¸ ì´ë¯¸ì§€ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤.\n12MB ì´í•˜ë¡œ ì¤„ì—¬ì„œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
          return;
        }

        const infoBox = document.getElementById(`info_${type}`);
        if(infoBox) infoBox.textContent = "â³ ì´ë¯¸ì§€ ì••ì¶• ì¤‘...";

        const result = await compressImageToDataURL(file, imageCompressionConfig);

        if (type === "default") {
          document.getElementById("pop_img_default").value = result.dataURL;
        } else {
          document.getElementById(`pop_img_${type}`).value = result.dataURL;
        }

        renderImagePreviews();

        if(infoBox){
          infoBox.innerHTML = `âœ… ì••ì¶• ì™„ë£Œ: <b>${result.sizeKB}KB</b> / ${result.width}x${result.height}px / í’ˆì§ˆ ${result.quality.toFixed(2)}`;
        }

        alert("âœ… ì—…ë¡œë“œ(ìë™ì••ì¶•) ì™„ë£Œ!\nì´ì œ 'ì €ì¥'ì„ ëˆ„ë¥´ë©´ íŒì—… ì´ë¯¸ì§€ë¡œ ì ìš©ë©ë‹ˆë‹¤.");
      } catch (e) {
        alert("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      }
    }

    function renderImagePreviews() {
      const defaultUrl = (document.getElementById("pop_img_default")?.value || "").trim();
      const enUrl = (document.getElementById("pop_img_en")?.value || "").trim();
      const viUrl = (document.getElementById("pop_img_vi")?.value || "").trim();
      const thUrl = (document.getElementById("pop_img_th")?.value || "").trim();
      const idUrl = (document.getElementById("pop_img_id")?.value || "").trim();

      renderOnePreview("preview_default", defaultUrl);
      renderOnePreview("preview_en", enUrl);
      renderOnePreview("preview_vi", viUrl);
      renderOnePreview("preview_th", thUrl);
      renderOnePreview("preview_id", idUrl);
    }

    function renderOnePreview(containerId, url) {
      const box = document.getElementById(containerId);
      if (!box) return;

      if (!url) {
        box.innerHTML = `<div class="small-note">ë¯¸ë¦¬ë³´ê¸° ì—†ìŒ</div>`;
        return;
      }

      box.innerHTML = `
        <img src="${url}" alt="preview" onerror="this.style.display='none';">
        <div class="small-note">âœ… ì ìš©ë¨</div>
      `;
    }
  </script>

</body>
</html>



