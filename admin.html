<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>K-Shopping 관리자 / Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- 엑셀(XLSX) 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#f7f7f7;
      color:#222;
    }
    a { text-decoration:none; color:inherit; }

    header {
      background:#222;
      color:#fff;
    }
    .header-inner{
      max-width:1100px;
      margin:0 auto;
      padding:10px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .header-title h1 { font-size:18px; }
    .header-title small { font-size:12px; color:#bbb; display:block; margin-top:2px; }

    main {
      max-width:1100px;
      margin:0 auto;
      padding:16px;
    }

    .card {
      background:#fff;
      border-radius:10px;
      padding:16px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
      margin-bottom:18px;
    }
    .card-title {
      font-size:16px;
      font-weight:600;
      margin-bottom:8px;
    }
    .card-sub {
      font-size:12px;
      color:#777;
      margin-bottom:10px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th, td {
      border-bottom:1px solid #eee;
      padding:6px 4px;
      text-align:left;
      vertical-align:middle;
    }
    th { background:#fafafa; font-weight:600; }
    .text-center { text-align:center; }
    .text-right { text-align:right; }

    input[type="text"],
    textarea {
      width:100%;
      padding:4px 6px;
      border:1px solid:#ccc;
      border-radius:4px;
      font-size:12px;
    }
    input[readonly] { background:#f5f5f5; }
    textarea { resize:vertical; min-height:60px; }

    input[type="number"] {
      width:110px;
      padding:4px 6px;
      border:1px solid #ccc;
      border-radius:4px;
      font-size:12px;
      -moz-appearance:textfield;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button{
      -webkit-appearance:none;
      margin:0;
    }

    .prod-name {
      width:100%;
      min-width:180px;
    }

    select {
      width:100%;
      padding:4px 6px;
      border:1px solid #ccc;
      border-radius:4px;
      font-size:12px;
    }

    button {
      font-family:inherit;
      cursor:pointer;
    }

    .btn-primary {
      border:none;
      background:#222;
      color:#fff;
      padding:8px 14px;
      border-radius:999px;
      font-size:13px;
      font-weight:600;
    }
    .btn-secondary {
      border:1px solid #ccc;
      background:#fff;
      color:#333;
      padding:6px 12px;
      border-radius:999px;
      font-size:12px;
    }
    .btn-danger {
      border:none;
      background:#e74c3c;
      color:#fff;
      padding:5px 10px;
      border-radius:4px;
      font-size:11px;
    }
    .btn-small {
      border:1px solid #aaa;
      background:#fff;
      color:#333;
      padding:4px 8px;
      border-radius:4px;
      font-size:11px;
    }

    .img-thumb {
      width:70px;
      height:50px;
      object-fit:cover;
      border-radius:4px;
      background:#eee;
    }

    .table-actions {
      display:flex;
      gap:4px;
      justify-content:center;
    }

    .flex-row {
      display:flex;
      gap:8px;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .field-inline {
      display:flex;
      gap:6px;
      align-items:center;
      margin-bottom:6px;
    }
    .field-inline label {
      width:120px;
      font-size:12px;
      color:#555;
    }

    @media(max-width:800px){
      table { font-size:11px; }
      th,td { padding:4px 2px; }
    }

    .small-hint {
      font-size:11px;
      color:#999;
      margin-top:2px;
    }
  </style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="header-title">
      <h1>K-Shopping 관리자 페이지</h1>
      <small>상품 / 카테고리 / 배너 / 입금 계좌 / 주문 엑셀 출력</small>
    </div>
    <button type="button" class="btn-secondary" onclick="location.href='index.html'">
      메인으로 이동
    </button>
  </div>
</header>

<main>
  <!-- 상품 관리 -->
  <section class="card">
    <div class="card-title">상품 관리 / Product Management</div>
    <div class="card-sub">
      상품 정보는 브라우저의 localStorage 에 저장됩니다.<br>
      Product data is stored locally in your browser (practice only).
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:40px;">No.</th>
          <th style="width:80px;">이미지</th>
          <th style="min-width:180px;">상품명</th>
          <th style="width:400px;">카테고리</th>
          <th style="width:5px;">출고가</th>
          <th style="width:5px;">특판가</th>
          <th style="width:240px;">목록용 이미지 URL</th>
          <th style="width:70px;">상세설명</th>
          <th style="width:120px;">이미지 파일(대표)</th>
          <th style="width:90px;">수정 / 삭제</th>
        </tr>
      </thead>
      <tbody id="productTableBody"></tbody>
    </table>

    <div class="flex-row">
      <button type="button" class="btn-secondary" onclick="addProductRow()">상품 추가</button>
      <button type="button" class="btn-primary" onclick="saveAllProducts()">상품 저장</button>
    </div>
  </section>

  <!-- 상세 설명 + 상세이미지 편집 영역 -->
  <section class="card" id="detailEditorCard">
    <div class="card-title">상세페이지 내용 입력 / Product Detail Description</div>
    <div class="card-sub">
      위 상품 목록의 연필 아이콘 또는 행을 클릭하면 선택된 상품의 상세내용이 아래에 표시됩니다.<br>
      Click the pencil icon or row in the product table, then edit the description here.
    </div>

    <div class="field-inline">
      <label>선택된 상품 / Selected product</label>
      <div id="detailSelectedName" style="font-size:13px;color:#333;">(선택된 상품 없음)</div>
    </div>

    <textarea id="detailEditor"
      placeholder="상세페이지에 노출할 내용을 한국어 또는 영어로 입력하세요. / Write detailed description for detail page."></textarea>

    <div class="field-inline" style="margin-top:8px;">
      <label>상세페이지 이미지 URL</label>
      <input id="detailImgUrlInput" type="text"
             placeholder="예: images/detail1.png 또는 https://...">
    </div>

    <div class="field-inline">
      <label>상세페이지 이미지 파일</label>
      <div style="flex:1;">
        <input id="detailImgFileInput" type="file" accept="image/*" />
        <div class="small-hint">
          파일을 선택하면 위 URL 칸에 자동으로 <code>images/파일명</code>이 입력됩니다.
          (이미지는 프로젝트 <code>images</code> 폴더에 올려 주세요.)
        </div>
      </div>
    </div>

    <div class="flex-row" style="margin-top:8px;">
      <button type="button" class="btn-secondary" onclick="clearDetailEditor()">
        초기화 / Clear
      </button>
      <button type="button" class="btn-primary" onclick="saveDetailDescription()">
        상세설명 저장 / Save Detail Description
      </button>
    </div>
  </section>

  <!-- 카테고리 관리 -->
  <section class="card">
    <div class="card-title">카테고리 관리 / Category Management</div>
    <div class="card-sub">
      카테고리 ID 는 영어/숫자로, 쇼핑몰 화면에는 "카테고리 이름"이 표시됩니다.<br>
      Category ID (English) is used internally, Category name is shown on the site.
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:120px;">카테고리 ID</th>
          <th>카테고리 이름</th>
          <th style="width:70px;">삭제</th>
        </tr>
      </thead>
      <tbody id="categoryTableBody"></tbody>
    </table>

    <div class="flex-row">
      <button type="button" class="btn-secondary" onclick="addCategoryRow()">카테고리 추가</button>
      <button type="button" class="btn-primary" onclick="saveCategories()">카테고리 저장</button>
    </div>
  </section>

  <!-- 배너 관리 -->
  <section class="card">
    <div class="card-title">배너 관리 / Banner Management</div>
    <div class="card-sub">
      메인 상단 프로모션 배너를 설정합니다. 여러 개를 만들면 자동 슬라이드됩니다.<br>
      ✨ <b>이미지는 Base64 로 저장하지 않고, 파일명만 저장</b>합니다.<br>
      &nbsp;&nbsp;- 이미지 파일은 프로젝트의 <code>images</code> 폴더에 넣어 주세요.<br>
      &nbsp;&nbsp;- 파일 선택 시 <code>이미지 URL</code>에 자동으로 <code>images/파일명</code> 이 입력됩니다.
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:40px;">사용</th>
          <th>제목</th>
          <th>부제목</th>
          <th>이미지 URL</th>
          <th style="width:120px;">이미지 파일(선택)</th>
          <th style="width:70px;">삭제</th>
        </tr>
      </thead>
      <tbody id="bannerTableBody"></tbody>
    </table>

    <div class="flex-row">
      <button type="button" class="btn-secondary" onclick="addBannerRow()">배너 추가</button>
      <button type="button" class="btn-primary" onclick="saveBanners()">배너 저장</button>
    </div>
  </section>

  <!-- 계좌 정보 -->
  <section class="card">
    <div class="card-title">입금 계좌 정보 / Bank Account Information</div>
    <div class="card-sub">
      주문 완료 페이지와 메인 화면 하단에 표시되는 계좌 정보를 설정합니다.
    </div>

    <div class="field-inline">
      <label>은행명 / Bank</label>
      <input id="accBank" />
    </div>
    <div class="field-inline">
      <label>계좌번호 / Account No.</label>
      <input id="accNumber" />
    </div>
    <div class="field-inline">
      <label>예금주 / Holder</label>
      <input id="accHolder" />
    </div>
    <!-- ✅ 고객센터 전화번호 관리용 필드 추가 -->
    <div class="field-inline">
      <label>고객센터 전화번호 / Customer Center Phone</label>
      <input id="accCustomerPhone" placeholder="예: 010-8640-8732" />
    </div>
    <div class="field-inline" style="align-items:flex-start;">
      <label>추가 안내 / Extra</label>
      <textarea id="accExtra" style="min-height:70px;"></textarea>
    </div>

    <div style="text-align:right;margin-top:10px;">
      <button type="button" class="btn-primary" onclick="saveAccountConfig()">계좌 정보 저장</button>
    </div>
  </section>

  <!-- 주문 엑셀 출력 & 전체 내역 보기 -->
  <section class="card">
    <div class="card-title">주문 내역 관리 / Orders Management</div>
    <div class="card-sub">
      order.html 에서 저장된 주문 내역(<code>orders</code>)을 사용합니다.<br>
      ● <b>주문 엑셀 다운로드</b> : 아직 엑셀로 내보내지 않은 신규 주문만 엑셀 파일로 저장합니다.<br>
      ● <b>전체 내역 출력</b> : 지금까지 저장된 모든 주문을 새 창에서 표로 확인합니다.<br>
      ● <b>전체 내역 엑셀</b> : 지금까지 저장된 모든 주문을 엑셀 파일로 저장합니다.
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button type="button" class="btn-primary" onclick="exportOrdersToExcel()">
        주문 엑셀 다운로드 / Download Orders Excel
      </button>
      <button type="button" class="btn-secondary" onclick="openOrdersWindow()">
        전체 내역 출력 / View All Orders
      </button>
      <button type="button" class="btn-secondary" onclick="exportAllOrdersToExcel()">
        전체 내역 엑셀 / Download All Orders Excel
      </button>
    </div>
  </section>

  <!-- 관리자용 주문 목록 (개별 출력) -->
  <section class="card">
    <div class="card-title">주문 목록 (관리자) / Admin Order List</div>
    <div class="card-sub">
      최신 주문이 위에 표시됩니다.<br>
      ● <b>출력</b> 버튼을 누르면 주문서가 새 창으로 열리고 인쇄 창이 뜹니다.<br>
      ● 출력이 완료되면 버튼 오른쪽에 <span style="color:#e74c3c;">출력완료</span> 표시가 나옵니다.<br>
      ● <b>주문 목록 새로 고침 / Refresh</b>를 누르면
         <b>이미 출력완료 된 주문은 목록에서 사라집니다.</b>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:40px;">No.</th>
          <th style="width:140px;">Order ID</th>
          <th style="width:160px;">DateTime</th>
          <th style="width:80px;">Name</th>
          <th>Items</th>
          <th style="width:120px;" class="text-center">출력</th>
        </tr>
      </thead>
      <tbody id="adminOrderListBody"></tbody>
    </table>
    <div style="text-align:right;margin-top:8px;">
      <button type="button" class="btn-secondary" onclick="renderAdminOrderList()">
        주문 목록 새로 고침 / Refresh
      </button>
    </div>
  </section>
</main>

<script>
  /* ===========================
     기본 데이터 정의
  ============================ */
  const defaultCategories = [
    { id:"laptop",  name:"노트북" },
    { id:"desktop", name:"데스크탑" },
    { id:"monitor", name:"모니터" },
    { id:"cat4",    name:"건강식품" }
  ];

  const defaultProducts = [
    {
      id:"p1",
      name:"게이밍 노트북 A (i7 · 16GB · 512GB)",
      categoryId:"laptop",
      priceOriginal:1490000,
      priceSale:1290000,
      imageUrl:"",
      desc:"15.6인치 · RTX 그래픽 · 무료배송 / 15.6\" · RTX GPU · Free Shipping",
      detailDesc:"",
      detailImageUrl:""
    },
    {
      id:"p2",
      name:"사무용 노트북 B (i5 · 8GB · 256GB)",
      categoryId:"laptop",
      priceOriginal:890000,
      priceSale:790000,
      imageUrl:"",
      desc:"가벼운 무게 · 사무/온라인 수업용 / Light weight · Office & Online class",
      detailDesc:"",
      detailImageUrl:""
    },
    {
      id:"p3",
      name:"게이밍 데스크탑 C (R7 · 16GB · 1TB)",
      categoryId:"desktop",
      priceOriginal:1790000,
      priceSale:1590000,
      imageUrl:"",
      desc:"RTX 그래픽 · RGB 케이스 / RTX GPU · RGB Case",
      detailDesc:"",
      detailImageUrl:""
    },
    {
      id:"p4",
      name:"27인치 모니터 D (144Hz)",
      categoryId:"monitor",
      priceOriginal:350000,
      priceSale:290000,
      imageUrl:"",
      desc:"144Hz · IPS 패널 / 144Hz · IPS Panel",
      detailDesc:"",
      detailImageUrl:""
    },
    {
      id:"p5",
      name:"흑염소육골진액",
      categoryId:"cat4",
      priceOriginal:198000,
      priceSale:55000,
      imageUrl:"",
      desc:"건강식품 예시",
      detailDesc:"",
      detailImageUrl:""
    },
    {
      id:"p6",
      name:"엘부민진액스틱",
      categoryId:"cat4",
      priceOriginal:70000,
      priceSale:35000,
      imageUrl:"",
      desc:"건강식품 예시",
      detailDesc:"",
      detailImageUrl:""
    }
  ];

  const defaultBanners = [
    {
      id:"b1",
      active:true,
      title:"11월 특가 노트북 세일 / Special Laptop Sale",
      subtitle:"인기 노트북 특판가 · 무료배송 / Popular laptops · Special price · Free shipping",
      imageUrl:""
    }
  ];

  const defaultAccountConfig = {
    bankName:"국민은행 KB Bank",
    accountNumber:"000000-00-000000",
    holder:"K-Shopping",
    extra:"입금자명은 주문자명과 동일하게 부탁드립니다.\nPlease use the same name as the order when making the bank transfer.",
    // ✅ 기본 고객센터 번호 추가
    customerPhone:"010-8640-8732"
  };

  const defaultImageMap = {
    p1:"https://picsum.photos/seed/p1/140/100",
    p2:"https://picsum.photos/seed/p2/140/100",
    p3:"https://picsum.photos/seed/p3/140/100",
    p4:"https://picsum.photos/seed/p4/140/100",
    p5:"https://picsum.photos/seed/p5/140/100",
    p6:"https://picsum.photos/seed/p6/140/100"
  };

  let products = [];
  let categories = [];
  let banners = [];
  let accountConfig = defaultAccountConfig;
  let currentDetailEditId = null;

  /* ===========================
     공통 유틸
  ============================ */
  function isQuotaError(e){
    return e && (
      e.name === "QuotaExceededError" ||
      e.name === "NS_ERROR_DOM_QUOTA_REACHED" ||
      e.code === 22 ||
      e.code === 1014
    );
  }

  // products 전용 저장 함수
  function saveProductsToStorage(arr){
    try{
      const cleaned = arr.map(p => {
        const { imageData, ...rest } = p || {};
        return rest;
      });
      localStorage.setItem("products", JSON.stringify(cleaned));
    }catch(e){
      if(isQuotaError(e)){
        alert(
          "브라우저 저장공간(localStorage)이 거의 가득 찼습니다.\n\n" +
          "이미지 파일(base64)은 저장하지 않고, 이미지 URL만 사용하도록 구성되어 있습니다.\n" +
          "상품 수를 줄이거나, 브라우저의 사이트 데이터(localStorage)를 정리한 뒤 다시 시도해 주세요."
        );
        console.warn("localStorage quota error while saving products:", e);
      }else{
        console.error(e);
        alert("상품 정보를 저장하는 중 오류가 발생했습니다.\n(콘솔을 확인해 주세요)");
      }
    }
  }

  function normalizeProduct(raw) {
    if (!raw) raw = {};
    return {
      id: raw.id || ("p" + Date.now() + Math.random().toString(16).slice(2)),
      name: raw.name || "",
      categoryId: raw.categoryId || (defaultCategories[0] && defaultCategories[0].id) || "",
      priceOriginal: Number(raw.priceOriginal) || 0,
      priceSale: Number(raw.priceSale) || 0,
      imageUrl: raw.imageUrl || "",
      desc: raw.desc || "",
      detailDesc: raw.detailDesc || "",
      detailImageUrl: raw.detailImageUrl || ""
    };
  }

  function getThumbUrl(p) {
    if (p.imageUrl && p.imageUrl.trim() !== "") return p.imageUrl.trim();
    return defaultImageMap[p.id] || "https://picsum.photos/seed/kshopping/140/100";
  }

  /* ===========================
     데이터 로드
  ============================ */
  function loadProducts() {
    try {
      const saved = localStorage.getItem("products");
      if (saved) {
        const arr = JSON.parse(saved);
        if (Array.isArray(arr) && arr.length) {
          products = arr.map(normalizeProduct);
          return;
        }
      }
    } catch (e) {
      console.warn("loadProducts 오류:", e);
    }
    products = defaultProducts.map(normalizeProduct);
  }

  function loadCategories() {
    try {
      const saved = localStorage.getItem("categories");
      if (saved) {
        const arr = JSON.parse(saved);
        if (Array.isArray(arr) && arr.length) {
          categories = arr;
          return;
        }
      }
    } catch(e){}
    categories = defaultCategories;
    localStorage.setItem("categories", JSON.stringify(categories));
  }

  function loadBanners() {
    try {
      const savedRaw = localStorage.getItem("banners");
      if (savedRaw) {
        if (savedRaw.length < 1000000) {
          const arr = JSON.parse(savedRaw);
          if (Array.isArray(arr) && arr.length) {
            banners = arr.map(b => ({
              id: b.id || ("b"+Date.now()),
              active: b.active !== false,
              title: b.title || "",
              subtitle: b.subtitle || "",
              imageUrl: b.imageUrl || ""
            }));
            return;
          }
        } else {
          console.warn("banners in localStorage too big, reset.");
          localStorage.removeItem("banners");
        }
      }
    } catch(e){}
    banners = defaultBanners;
    try { localStorage.setItem("banners", JSON.stringify(banners)); } catch(e){}
  }

  function loadAccountConfig() {
    try {
      const saved = localStorage.getItem("accountConfig");
      if (saved) {
        const obj = JSON.parse(saved);
        accountConfig = Object.assign({}, defaultAccountConfig, obj || {});
        return;
      }
    } catch(e){}
    accountConfig = defaultAccountConfig;
    localStorage.setItem("accountConfig", JSON.stringify(accountConfig));
  }

  /* ===========================
     상품 테이블 렌더링
  ============================ */
  function renderProductsTable() {
    const tbody = document.getElementById("productTableBody");
    tbody.innerHTML = "";

    products.forEach((p, idx) => {
      const tr = document.createElement("tr");
      tr.dataset.pid = p.id;

      tr.innerHTML = `
        <td class="text-center">
          ${idx + 1}
          <input type="hidden" class="prod-id" value="${p.id}" />
        </td>
        <td class="text-center">
          <img class="img-thumb" src="${getThumbUrl(p)}" alt="${p.name}" />
        </td>
        <td><input type="text" class="prod-name" value="${p.name}" /></td>
        <td><select class="prod-category"></select></td>
        <td><input type="number" class="prod-original" value="${p.priceOriginal || 0}" /></td>
        <td><input type="number" class="prod-sale" value="${p.priceSale || 0}" /></td>
        <td><input type="text" class="prod-image-url" value="${p.imageUrl || ""}" /></td>
        <td class="text-center">
          <button type="button" class="btn-small btn-detail-edit">편집</button>
        </td>
        <td>
          <input type="file" class="prod-image-file" accept="image/*" />
          <div class="small-hint">
            여기서 선택한 파일은 <b>현재 화면 미리보기용</b>입니다.<br>
            실제 저장/노출에는 위의 "목록용 이미지 URL" 값만 사용됩니다.
          </div>
        </td>
        <td>
          <div class="table-actions">
            <button type="button" class="btn-small btn-row-save">수정</button>
            <button type="button" class="btn-danger btn-row-delete">삭제</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);

      const catSelect = tr.querySelector(".prod-category");
      categories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat.id;
        opt.textContent = cat.name;
        if (cat.id === p.categoryId) opt.selected = true;
        catSelect.appendChild(opt);
      });

      const fileInput = tr.querySelector(".prod-image-file");
      const urlInput  = tr.querySelector(".prod-image-url");
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const img = tr.querySelector(".img-thumb");
        const objectUrl = URL.createObjectURL(file);
        img.src = objectUrl;
        if (urlInput) urlInput.value = "images/" + file.name;
      });

      tr.querySelector(".btn-row-save").addEventListener("click", () => {
        saveSingleProductRow(tr);
        alert("해당 상품 정보가 저장되었습니다.");
      });

      tr.querySelector(".btn-row-delete").addEventListener("click", () => {
        if (!confirm("해당 상품을 삭제하시겠습니까?")) return;
        products = products.filter(prod => prod.id !== p.id);
        saveProductsToStorage(products);
        renderProductsTable();
      });

      tr.querySelector(".btn-detail-edit").addEventListener("click", () => {
        openDetailEditor(p.id);
      });

      tr.addEventListener("click", (ev) => {
        const tag = ev.target.tagName.toLowerCase();
        if (tag === "button" || tag === "input" || tag === "select") return;
        openDetailEditor(p.id);
      });
    });
  }

  function saveSingleProductRow(tr) {
    const pid = tr.dataset.pid;
    const idx = products.findIndex(p => p.id === pid);
    if (idx === -1) return;

    const p = products[idx];
    p.name          = tr.querySelector(".prod-name").value.trim();
    p.categoryId    = tr.querySelector(".prod-category").value;
    p.priceOriginal = Number(tr.querySelector(".prod-original").value) || 0;
    p.priceSale     = Number(tr.querySelector(".prod-sale").value) || 0;
    p.imageUrl      = tr.querySelector(".prod-image-url").value.trim();

    products[idx] = normalizeProduct(p);
    saveProductsToStorage(products);
  }

  function saveAllProducts() {
    const tbody = document.getElementById("productTableBody");
    if (!tbody) return;
    const rows = tbody.querySelectorAll("tr");
    const newProducts = [];

    const getVal = (tr, selector, def="") => {
      const el = tr.querySelector(selector);
      if (!el) return def;
      return (el.value ?? "").toString();
    };

    rows.forEach(tr => {
      const hiddenIdInput = tr.querySelector(".prod-id");
      let pid =
        (hiddenIdInput && hiddenIdInput.value.trim()) ||
        (tr.dataset.pid || "");

      if (!pid) {
        pid = "p" + Date.now() + Math.random().toString(16).slice(2);
      }

      const old = (Array.isArray(products) ? products : []).find(p => p.id === pid) || {};

      const merged = normalizeProduct({
        id: pid,
        name: getVal(tr, ".prod-name", old.name || "").trim(),
        categoryId: getVal(tr, ".prod-category", old.categoryId || "laptop"),
        priceOriginal: Number(getVal(tr, ".prod-original", old.priceOriginal || 0)) || 0,
        priceSale: Number(getVal(tr, ".prod-sale", old.priceSale || 0)) || 0,
        imageUrl: getVal(tr, ".prod-image-url", old.imageUrl || "").trim(),
        desc: old.desc || "",
        detailDesc: old.detailDesc || "",
        detailImageUrl: old.detailImageUrl || ""
      });

      newProducts.push(merged);
    });

    products = newProducts;
    saveProductsToStorage(products);
    alert("모든 상품 정보가 저장되었습니다.");
    renderProductsTable();
  }

  function addProductRow() {
    const newId = "p" + Date.now();
    products.push(normalizeProduct({
      id:newId,
      name:"새 상품",
      categoryId: categories[0]?.id || "laptop",
      priceOriginal:0,
      priceSale:0,
      imageUrl:"",
      desc:"",
      detailDesc:"",
      detailImageUrl:""
    }));
    saveProductsToStorage(products);
    renderProductsTable();
  }

  /* ===========================
     상세 설명 + 상세이미지 편집
  ============================ */
  function openDetailEditor(productId) {
    const p = products.find(prod => prod.id === productId);
    if (!p) return;
    currentDetailEditId = productId;

    document.getElementById("detailSelectedName").textContent =
      `${p.id} / ${p.name}`;
    document.getElementById("detailEditor").value = p.detailDesc || "";
    document.getElementById("detailImgUrlInput").value = p.detailImageUrl || "";
    const fileInput = document.getElementById("detailImgFileInput");
    if (fileInput) fileInput.value = "";

    document.getElementById("detailEditorCard").scrollIntoView({behavior:"smooth"});
  }

  function clearDetailEditor() {
    document.getElementById("detailEditor").value = "";
    document.getElementById("detailImgUrlInput").value = "";
  }

  function saveDetailDescription() {
    if (!currentDetailEditId) {
      alert("먼저 상품 목록에서 편집할 상품을 선택해 주세요.");
      return;
    }
    const text = document.getElementById("detailEditor").value;
    const imgUrl = document.getElementById("detailImgUrlInput").value.trim();
    const idx = products.findIndex(p => p.id === currentDetailEditId);
    if (idx === -1) {
      alert("선택된 상품을 찾을 수 없습니다.");
      return;
    }
    products[idx].detailDesc = text;
    products[idx].detailImageUrl = imgUrl;
    products[idx] = normalizeProduct(products[idx]);
    saveProductsToStorage(products);
    alert("상세설명과 상세이미지 정보가 저장되었습니다.");
  }

  /* ===========================
     카테고리
  ============================ */
  function renderCategoryTable() {
    const tbody = document.getElementById("categoryTableBody");
    tbody.innerHTML = "";
    categories.forEach(cat => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text" class="cat-id" value="${cat.id}" /></td>
        <td><input type="text" class="cat-name" value="${cat.name}" /></td>
        <td class="text-center">
          <button type="button" class="btn-danger btn-cat-del">삭제</button>
        </td>
      `;
      tbody.appendChild(tr);

      tr.querySelector(".btn-cat-del").addEventListener("click", () => {
        if (!confirm("해당 카테고리를 삭제하시겠습니까?\n(상품의 categoryId 는 직접 수정해야 합니다.)")) return;
        categories = categories.filter(c => c !== cat);
        renderCategoryTable();
      });
    });
  }

  function addCategoryRow() {
    categories.push({ id:"", name:"새 카테고리" });
    renderCategoryTable();
  }

  function saveCategories() {
    const tbody = document.getElementById("categoryTableBody");
    const rows = tbody.querySelectorAll("tr");
    const arr = [];
    rows.forEach(tr => {
      const id = tr.querySelector(".cat-id").value.trim();
      const name = tr.querySelector(".cat-name").value.trim();
      if (!id || !name) return;
      arr.push({ id, name });
    });
    categories = arr;
    localStorage.setItem("categories", JSON.stringify(categories));
    alert("카테고리가 저장되었습니다. (상품 카테고리 선택에도 바로 반영됩니다.)");
    renderProductsTable();
  }

  /* ===========================
     배너
  ============================ */
  function renderBannerTable() {
    const tbody = document.getElementById("bannerTableBody");
    tbody.innerHTML = "";
    banners.forEach(b => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="text-center">
          <input type="checkbox" class="banner-active" ${b.active !== false ? "checked" : ""} />
        </td>
        <td><input type="text" class="banner-title" value="${b.title || ""}" /></td>
        <td><input type="text" class="banner-subtitle" value="${b.subtitle || ""}" /></td>
        <td>
          <input type="text" class="banner-img-url"
                 placeholder="예: images/banner1.png"
                 value="${b.imageUrl || ""}" />
          <div class="small-hint">직접 입력하거나 아래에서 파일 선택하세요.</div>
        </td>
        <td>
          <input type="file" class="banner-img-file" accept="image/*" />
          <div class="small-hint">파일 선택 시 위 URL에 자동으로 <code>images/파일명</code>이 입력됩니다.</div>
        </td>
        <td class="text-center">
          <button type="button" class="btn-danger btn-banner-del">삭제</button>
        </td>
      `;
      tbody.appendChild(tr);

      const fileInput = tr.querySelector(".banner-img-file");
      const urlInput  = tr.querySelector(".banner-img-url");

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        urlInput.value = "images/" + file.name;
      });

      tr.querySelector(".btn-banner-del").addEventListener("click", () => {
        banners = banners.filter(x => x !== b);
        renderBannerTable();
      });
    });
  }

  function addBannerRow() {
    banners.push({
      id:"b"+Date.now(),
      active:true,
      title:"",
      subtitle:"",
      imageUrl:""
    });
    renderBannerTable();
  }

  function saveBanners() {
    const tbody = document.getElementById("bannerTableBody");
    const rows = tbody.querySelectorAll("tr");
    const arr = [];

    rows.forEach((tr, idx) => {
      arr.push({
        id:"b"+idx+"_"+Date.now(),
        active: tr.querySelector(".banner-active").checked,
        title: (tr.querySelector(".banner-title").value || "").trim(),
        subtitle: (tr.querySelector(".banner-subtitle").value || "").trim(),
        imageUrl: (tr.querySelector(".banner-img-url").value || "").trim()
      });
    });

    banners = arr;
    try {
      localStorage.setItem("banners", JSON.stringify(banners));
      alert("배너 설정이 저장되었습니다.");
    } catch (e) {
      alert(
        "배너를 저장하는 중 오류가 발생했습니다.\n(localStorage 용량 초과 등)\n\n" +
        "브라우저의 사이트 데이터(localStorage)를 정리한 뒤 다시 시도해 주세요."
      );
      console.error(e);
    }
  }

  /* ===========================
     계좌 정보
  ============================ */
  function renderAccountForm() {
    document.getElementById("accBank").value   = accountConfig.bankName || "";
    document.getElementById("accNumber").value = accountConfig.accountNumber || "";
    document.getElementById("accHolder").value = accountConfig.holder || "";
    document.getElementById("accCustomerPhone").value = accountConfig.customerPhone || "";
    document.getElementById("accExtra").value  = accountConfig.extra || "";
  }

  function saveAccountConfig() {
    accountConfig = {
      bankName: document.getElementById("accBank").value.trim(),
      accountNumber: document.getElementById("accNumber").value.trim(),
      holder: document.getElementById("accHolder").value.trim(),
      customerPhone: document.getElementById("accCustomerPhone").value.trim(),
      extra: document.getElementById("accExtra").value
    };
    localStorage.setItem("accountConfig", JSON.stringify(accountConfig));
    alert("계좌 정보가 저장되었습니다.");
  }

  /* ===========================
     주문 데이터 + 품목 추출
  ============================ */
  function loadOrdersFromStorage() {
    let orders = [];
    try {
      const saved = localStorage.getItem("orders");
      if (saved) orders = JSON.parse(saved);
    } catch (e) {
      console.error(e);
      orders = [];
    }
    if (!Array.isArray(orders)) orders = [];
    return orders;
  }

  function formatDateTimeLocal(value) {
    if (!value) return "";
    const d = new Date(value);
    if (isNaN(d.getTime())) return "";
    const pad = n => String(n).padStart(2,"0");
    return (
      d.getFullYear() + "-" +
      pad(d.getMonth()+1) + "-" +
      pad(d.getDate()) + " " +
      pad(d.getHours()) + ":" +
      pad(d.getMinutes()) + ":" +
      pad(d.getSeconds())
    );
  }

  function getOrderItemsArray(o) {
    if (!o || typeof o !== "object") return [];
    const keys = [
      "items",
      "cartItems",
      "orderItems",
      "products",
      "cart",
      "lines"
    ];
    for (const k of keys) {
      const v = o[k];
      if (Array.isArray(v) && v.length) return v;
    }
    if (o.itemName || o.productName || o.title) {
      return [{
        name: o.itemName || o.productName || o.title,
        qty:  o.qty || o.quantity || o.count || o.totalQty || 1,
        priceSale: o.unitPrice || o.price || o.priceSale || 0
      }];
    }
    return [];
  }

  function getOrderItemsText(o) {
    const arr = getOrderItemsArray(o);
    if (arr.length) {
      return arr.map(it => {
        const name = it.name || it.productName || it.title || "-";
        const qty  = it.qty ?? it.quantity ?? it.count ?? 1;
        return `${name} x${qty}`;
      }).join("; ");
    }
    if (o.itemsText || o.itemsSummary || o.itemSummary) {
      return o.itemsText || o.itemsSummary || o.itemSummary;
    }
    return "";
  }

  /* ===========================
     주문 엑셀 출력 (신규 주문만)
  ============================ */
  function exportOrdersToExcel() {
    const allOrders = loadOrdersFromStorage();
    if (!allOrders.length) {
      alert("저장된 주문 내역이 없습니다.");
      return;
    }

    const targets = allOrders.filter(o => !o.exported);
    if (!targets.length) {
      alert("엑셀로 내보낼 신규 주문이 없습니다.");
      return;
    }

    const rows = targets.map(order => {
      const o = order || {};

      const methodLabel =
        o.method === "call"
          ? "전화 요청 / Phone"
          : "폼 입력 / Form";

      let name = "";
      let phone = "";
      let address = "";
      let request = "";

      if (o.customer) {
        name    = o.customer.name    || "";
        phone   = o.customer.phone   || "";
        address = o.customer.address || "";
        request = o.customer.memo    || "";
      } else if (o.callRequest || o.callSupport) {
        const c = o.callRequest || o.callSupport;
        phone = c.phone || "";
        const parts = [];
        if (c.time) parts.push("시간:" + c.time);
        if (c.memo) parts.push("메모:" + c.memo);
        request = parts.join(" / ");
      } else {
        name    = o.name    || "";
        phone   = o.phone   || "";
        address = o.address || "";
        request = o.memo || o.request || "";
      }

      const itemsArr = getOrderItemsArray(o);
      const itemsStr = getOrderItemsText(o);

      let totalQty = (typeof o.totalQty === "number") ? o.totalQty : 0;
      let subtotal = (typeof o.subtotal === "number") ? o.subtotal : 0;
      const shipping = (typeof o.shipping === "number") ? o.shipping : 0;

      if ((totalQty === 0 || subtotal === 0) && itemsArr.length) {
        totalQty = 0;
        subtotal = 0;
        itemsArr.forEach(it => {
          const q = Number(it.qty ?? it.quantity ?? it.count ?? 1);
          const p = Number(it.priceSale ?? it.price ?? it.unitPrice ?? 0);
          totalQty += q;
          subtotal += q * p;
        });
      }

      const totalAmount = (typeof o.totalAmount === "number")
        ? o.totalAmount
        : subtotal + shipping;

      const dateStr = formatDateTimeLocal(o.date || o.createdAt || o.orderTime);

      return {
        OrderID:     o.id || "",
        DateTime:    dateStr,
        Method:      methodLabel,
        Name:        name,
        Phone:       phone,
        Address:     address,
        Request:     request,
        Items:       itemsStr,
        TotalQty:    totalQty,
        Subtotal:    subtotal,
        Shipping:    shipping,
        TotalAmount: totalAmount
      };
    });

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Orders");

    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    const filename = `kshopping_orders_${y}-${m}-${d}.xlsx`;
    XLSX.writeFile(wb, filename);

    const updated = allOrders.map(o => {
      if (!o.exported) return { ...o, exported: true };
      return o;
    });
    localStorage.setItem("orders", JSON.stringify(updated));

    alert(`새 주문 ${targets.length}건을 엑셀로 저장했습니다.\n(다음 출력부터는 이번에 출력한 주문은 제외됩니다.)`);
  }

  /* ===========================
     전체 주문 엑셀 출력 (모든 주문)
  ============================ */
  function exportAllOrdersToExcel() {
    const allOrders = loadOrdersFromStorage();
    if (!allOrders.length) {
      alert("저장된 주문 내역이 없습니다.");
      return;
    }

    const rows = allOrders.map(order => {
      const o = order || {};

      const methodLabel =
        o.method === "call"
          ? "전화 요청 / Phone"
          : "폼 입력 / Form";

      let name = "";
      let phone = "";
      let address = "";
      let request = "";

      if (o.customer) {
        name    = o.customer.name    || "";
        phone   = o.customer.phone   || "";
        address = o.customer.address || "";
        request = o.customer.memo    || "";
      } else if (o.callRequest || o.callSupport) {
        const c = o.callRequest || o.callSupport;
        phone = c.phone || "";
        const parts = [];
        if (c.time) parts.push("시간:" + c.time);
        if (c.memo) parts.push("메모:" + c.memo);
        request = parts.join(" / ");
      } else {
        name    = o.name    || "";
        phone   = o.phone   || "";
        address = o.address || "";
        request = o.memo || o.request || "";
      }

      const itemsArr = getOrderItemsArray(o);
      const itemsStr = getOrderItemsText(o);

      let totalQty = (typeof o.totalQty === "number") ? o.totalQty : 0;
      let subtotal = (typeof o.subtotal === "number") ? o.subtotal : 0;
      const shipping = (typeof o.shipping === "number") ? o.shipping : 0;

      if ((totalQty === 0 || subtotal === 0) && itemsArr.length) {
        totalQty = 0;
        subtotal = 0;
        itemsArr.forEach(it => {
          const q = Number(it.qty ?? it.quantity ?? it.count ?? 1);
          const p = Number(it.priceSale ?? it.price ?? it.unitPrice ?? 0);
          totalQty += q;
          subtotal += q * p;
        });
      }

      const totalAmount = (typeof o.totalAmount === "number")
        ? o.totalAmount
        : subtotal + shipping;

      const dateStr = formatDateTimeLocal(o.date || o.createdAt || o.orderTime);

      return {
        OrderID:     o.id || "",
        DateTime:    dateStr,
        Method:      methodLabel,
        Name:        name,
        Phone:       phone,
        Address:     address,
        Request:     request,
        Items:       itemsStr,
        TotalQty:    totalQty,
        Subtotal:    subtotal,
        Shipping:    shipping,
        TotalAmount: totalAmount
      };
    });

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "AllOrders");

    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    const filename = `kshopping_orders_all_${y}-${m}-${d}.xlsx`;
    XLSX.writeFile(wb, filename);

    alert(`전체 주문 ${allOrders.length}건을 엑셀로 저장했습니다.`);
  }

  /* ===========================
     전체 주문 내역 새 창에서 보기
  ============================ */
  function openOrdersWindow() {
    const orders = loadOrdersFromStorage();
    if (!orders.length) {
      alert("저장된 주문 내역이 없습니다.");
      return;
    }

    const win = window.open("", "kshopping_all_orders");
    if (!win) {
      alert("팝업이 차단되었습니다. 브라우저 팝업 허용 후 다시 시도해 주세요.");
      return;
    }

    let html = `
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <title>K-Shopping 주문 전체 내역</title>
        <style>
          body { font-family: system-ui, sans-serif; font-size: 12px; margin:16px; }
          h1 { font-size:18px; margin-bottom:10px; }
          table { width:100%; border-collapse:collapse; }
          th, td {
            border:1px solid #ddd;
            padding:4px 6px;
            text-align:left;
            vertical-align:top;
          }
          th { background:#f5f5f5; }
          .text-right { text-align:right; }
        </style>
      </head>
      <body>
        <h1>K-Shopping 주문 전체 내역 / All Orders</h1>
        <table>
          <thead>
            <tr>
              <th>No.</th>
              <th>Order ID</th>
              <th>DateTime</th>
              <th>Method</th>
              <th>Name</th>
              <th>Phone</th>
              <th>Address</th>
              <th>Request</th>
              <th>Items</th>
              <th class="text-right">Total Amount</th>
              <th>Exported</th>
            </tr>
          </thead>
          <tbody>
    `;

    orders.forEach((o, idx) => {
      const methodLabel =
        o.method === "call"
          ? "전화요청 / Phone"
          : "폼입력 / Form";

      let name = "";
      let phone = "";
      let address = "";
      let request = "";

      if (o.customer) {
        name    = o.customer.name    || "";
        phone   = o.customer.phone   || "";
        address = o.customer.address || "";
        request = o.customer.memo    || "";
      } else if (o.callRequest || o.callSupport) {
        const c = o.callRequest || o.callSupport;
        phone = c.phone || "";
        const parts = [];
        if (c.time) parts.push("시간:" + c.time);
        if (c.memo) parts.push("메모:" + c.memo);
        request = parts.join(" / ");
      } else {
        name    = o.name    || "";
        phone   = o.phone   || "";
        address = o.address || "";
        request = o.memo || o.request || "";
      }

      const itemsStr = getOrderItemsText(o);
      const totalAmount = (typeof o.totalAmount === "number") ? o.totalAmount : 0;
      const dateStr = formatDateTimeLocal(o.date || o.createdAt || o.orderTime);

      html += `
        <tr>
          <td>${idx + 1}</td>
          <td>${o.id || ""}</td>
          <td>${dateStr}</td>
          <td>${methodLabel}</td>
          <td>${name}</td>
          <td>${phone}</td>
          <td>${address}</td>
          <td>${request}</td>
          <td>${itemsStr}</td>
          <td class="text-right">${totalAmount.toLocaleString("ko-KR")}원</td>
          <td>${o.exported ? "Y" : ""}</td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </body>
      </html>
    `;

    win.document.open();
    win.document.write(html);
    win.document.close();
  }

  /* ===========================
     관리자용 주문 목록 + 개별 출력
     - 출력 버튼 클릭 시: 새 창 + window.print()
     - 출력 후: orders 데이터에 printed:true 저장
     - 같은 행에 "출력완료" 표시
     - 새로고침 시 printed 된 주문은 목록에서 제외
  ============================ */
  function renderAdminOrderList() {
    const tbody = document.getElementById("adminOrderListBody");
    if (!tbody) return;

    const allOrders = loadOrdersFromStorage();
    const orders = allOrders.filter(o => !o.printed);  // 출력완료 제외

    tbody.innerHTML = "";

    if (!orders.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="6" style="text-align:center;color:#777;">출력할 주문이 없습니다.</td>`;
      tbody.appendChild(tr);
      return;
    }

    const list = [...orders].reverse(); // 최신 주문이 위로
    list.forEach((o, idx) => {
      const tr = document.createElement("tr");
      const dateStr = formatDateTimeLocal(o.date || o.createdAt || o.orderTime);
      const name = (o.customer && o.customer.name) || o.name || "";
      const items = getOrderItemsText(o);

      tr.innerHTML = `
        <td class="text-center">${idx + 1}</td>
        <td>${o.id || ""}</td>
        <td>${dateStr}</td>
        <td>${name}</td>
        <td>${items}</td>
        <td class="text-center">
          <button type="button" class="btn-small" onclick="openOrderPrint('${o.id || ""}', this)">출력</button>
          <span class="print-status" style="color:#e74c3c;font-size:11px;margin-left:4px;"></span>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function openOrderPrint(orderId, btnEl) {
    let orders = loadOrdersFromStorage();
    const idx = orders.findIndex(o => o.id === orderId);
    if (idx === -1) {
      alert("해당 주문을 찾을 수 없습니다.");
      return;
    }
    const order = orders[idx];

    const win = window.open("", "kshopping_order_print_" + (order.id || ""));
    if (!win) {
      alert("팝업이 차단되었습니다. 팝업 허용 후 다시 시도해 주세요.");
      return;
    }

    const fmtPrice = (n) => Number(n || 0).toLocaleString("ko-KR") + "원";
    const dateStr = formatDateTimeLocal(order.date || order.createdAt || order.orderTime);
    const methodLabel = order.method === "call"
      ? "전화 주문 / Phone Order"
      : "온라인 주문서 / Online Order Form";

    let name = "", phone = "", address = "", memo = "";
    if (order.customer) {
      name = order.customer.name || "";
      phone = order.customer.phone || "";
      address = order.customer.address || "";
      memo = order.customer.memo || "";
    } else {
      name = order.name || "";
      phone = order.phone || "";
      address = order.address || "";
      memo = order.memo || order.request || "";
    }

    const itemsArr = getOrderItemsArray(order);
    let rows = "";
    let totalQty = 0;
    let subtotal = 0;
    itemsArr.forEach(it => {
      const q = Number(it.qty ?? it.quantity ?? it.count ?? 1);
      const p = Number(it.priceSale ?? it.price ?? it.unitPrice ?? 0);
      const line = q * p;
      totalQty += q;
      subtotal += line;
      const itemName = it.name || it.productName || it.title || "-";
      rows += `
        <tr>
          <td>${itemName}</td>
          <td class="text-right">${q}</td>
          <td class="text-right">${fmtPrice(p)}</td>
          <td class="text-right">${fmtPrice(line)}</td>
        </tr>
      `;
    });

    if (typeof order.totalQty === "number") totalQty = order.totalQty;
    if (typeof order.subtotal === "number") subtotal = order.subtotal;
    const shipping = typeof order.shipping === "number" ? order.shipping : 0;
    let totalAmount = subtotal + shipping;
    if (typeof order.totalAmount === "number") totalAmount = order.totalAmount;

    const addrConfirm = address
      ? `<div class="address-box">
          아래 주소로 배송이 진행됩니다. 주소가 정확한지 다시 한 번 확인해 주세요.<br>
          Your order will be shipped to the address below. Please make sure it is correct.
          <b>${address}</b>
        </div>`
      : "";

    win.document.open();
    win.document.write(`
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>K-Shopping 주문 상세 / Order Details</title>
  <style>
    body { background:#f7f7f7; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; color:#222; }
    .card { background:#fff; max-width:900px; margin:20px auto; padding:16px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    h1 { font-size:20px; margin-bottom:10px; }
    h2 { font-size:16px; margin:16px 0 8px; }
    p  { font-size:13px; line-height:1.6; margin:2px 0; }
    table { width:100%; border-collapse:collapse; font-size:13px; margin-top:6px; }
    th,td { border-bottom:1px solid #eee; padding:4px 2px; text-align:left; }
    th { background:#fafafa; }
    .text-right { text-align:right; }
    .address-box {
      margin-top:10px; padding:10px 12px;
      border-radius:8px; border:1px solid #ffd591; background:#fff7e6;
      font-size:13px; line-height:1.5;
    }
    .address-box b { display:block; margin-top:4px; }
    .btn-print {
      display:inline-block; margin-top:12px; padding:8px 14px;
      border-radius:999px; border:1px solid #333; background:#fff; cursor:pointer;
      font-size:13px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>주문 정보 / Order Details</h1>
    <p>주문번호 / Order ID : <b>${order.id || ""}</b></p>
    <p>주문 방식 / Method : <b>${methodLabel}</b></p>
    <p>주문일시 / Date : ${dateStr}</p>
    <br />
    <p>이름 / Name : ${name || "-"}</p>
    <p>연락처 / Phone : ${phone || "-"}</p>
    <p>주소 / Address : ${address || "-"}</p>
    <p>요청사항 / Request : ${memo || "-"}</p>
    ${addrConfirm}
    <h2>주문 상품 / Ordered Items</h2>
    <table>
      <thead>
        <tr>
          <th>상품명 / Product</th>
          <th class="text-right">수량 / Qty</th>
          <th class="text-right">단가 / Price</th>
          <th class="text-right">금액 / Amount</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
    <p style="margin-top:8px;">
      총 수량 / Total Qty : <b>${totalQty}</b><br>
      상품 합계 / Subtotal : <b>${fmtPrice(subtotal)}</b><br>
      배송비 / Shipping : <b>${shipping === 0 ? "0원 (또는 무료)" : fmtPrice(shipping)}</b><br>
      최종 결제 예정 금액 / Total Amount : <b>${fmtPrice(totalAmount)}</b>
    </p>
    <button class="btn-print" onclick="window.print()">인쇄 / Print</button>
  </div>
</body>
</html>
    `);
    win.document.close();
    win.focus();
    win.print();

    // 1) 주문에 printed 플래그 저장
    orders[idx] = { ...order, printed:true };
    localStorage.setItem("orders", JSON.stringify(orders));

    // 2) 현재 행에 "출력완료" 표시
    if (btnEl) {
      const row = btnEl.closest("tr");
      if (row) {
        const span = row.querySelector(".print-status");
        if (span) span.textContent = "출력완료";
      }
    }
  }

  /* ===========================
     DOM 로드 시 초기화
  ============================ */
  document.addEventListener("DOMContentLoaded", () => {
    loadCategories();
    loadProducts();
    loadBanners();
    loadAccountConfig();

    renderProductsTable();
    renderCategoryTable();
    renderBannerTable();
    renderAccountForm();
    renderAdminOrderList();   // ✅ 주문 목록 자동 로드

    const detailFileInput = document.getElementById("detailImgFileInput");
    if (detailFileInput) {
      detailFileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const urlInput = document.getElementById("detailImgUrlInput");
        if (urlInput) {
          urlInput.value = "images/" + file.name;
        }
      });
    }
  });
</script>
</body>
</html>
