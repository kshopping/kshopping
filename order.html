<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì£¼ë¬¸ ì§„í–‰ì¤‘ / Order in Progress - K-Shopping</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      background:#f7f7f7;
      font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color:#222;
    }
    main {
      max-width:900px;
      margin:0 auto;
      padding:16px;
    }
    h1 { font-size:22px; margin-bottom:8px; }
    .sub { font-size:13px; color:#777; margin-bottom:18px; }

    .card {
      background:#fff;
      border-radius:10px;
      padding:14px 16px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
      margin-bottom:16px;
    }
    .card-title { font-size:16px; font-weight:600; margin-bottom:6px; }
    .card-sub { font-size:12px; color:#777; margin-bottom:10px; }

    label { font-size:13px; display:block; margin:8px 0 4px; }
    input, textarea {
      width:100%;
      border:1px solid #ddd;
      border-radius:6px;
      padding:8px 10px;
      font-size:13px;
    }
    textarea { min-height:60px; resize:vertical; }

    .btn-primary {
      border:none;
      background:#222;
      color:#fff;
      padding:10px 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-secondary {
      border:1px solid #ccc;
      background:#fff;
      color:#333;
      padding:8px 14px;
      border-radius:999px;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
    }

    .btn-primary:hover { background:#000; }
    .btn-secondary:hover { background:#f5f5f5; }

    .btn-row {
      display:flex;
      justify-content:space-between;
      gap:8px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:13px;
    }
    th, td {
      border-bottom:1px solid #eee;
      padding:4px 2px;
      text-align:left;
    }
    th { background:#fafafa; }
    .text-right { text-align:right; }

    .summary-footer {
      margin-top:8px;
      font-size:13px;
    }

    .cart-qty-btn {
      border:1px solid #ccc;
      background:#fff;
      color:#333;
      padding:2px 6px;
      border-radius:4px;
      font-size:11px;
      cursor:pointer;
    }
    .cart-qty-input {
      width:48px;
      padding:3px 4px;
      margin:0 2px;
      font-size:12px;
      text-align:right;
    }
    .cart-del-btn {
      border:none;
      background:#e74c3c;
      color:#fff;
      padding:4px 8px;
      border-radius:4px;
      font-size:11px;
      cursor:pointer;
    }

    @media (max-width:600px){
      .btn-row {
        display:flex;
        flex-direction:column-reverse;
        gap:8px;
      }
    }

    /* === Header === */
    .ks-header {
      position: sticky;
      top: 0;
      z-index: 999;
      background-color: #ffffff;
      border-bottom: 1px solid #eee;
    }
    .ks-header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .ks-header-spacer { height: 64px; }

    .ks-logo {
      display: flex;
      flex-direction: column;
      cursor: pointer;
      margin-right: 12px;
      white-space: nowrap;
    }
    .ks-logo-main {
      font-weight: 800;
      font-size: 22px;
      letter-spacing: 0.3px;
    }
    .ks-logo-sub {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.3px;
      margin-top: 2px;
    }
    .ks-logo-sub .kor { color: #0066d9; }
    .ks-logo-sub .eng {
      background: linear-gradient(90deg, #0099ff, #00c58e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
    }

    .ks-nav {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      overflow-x: auto;
    }

    .ks-actions {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .ks-icon-btn {
      border: none;
      background: transparent;
      font-size: 13px;
      cursor: pointer;
      position: relative;
    }
    .ks-icon-btn .cart-label {
      font-weight: 700;
      color: #ff4d4f;
    }

    .cart-icon-wrapper {
      width: 38px;
      height: 38px;
      background: #ff4d4f;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      position: relative;
      transition: 0.15s;
    }
    .cart-icon-wrapper:hover {
      background: #e0242a;
      transform: translateY(-1px);
    }
    .cart-icon-wrapper img {
      width: 19px;
      filter: invert(100%);
    }
    .ks-cart-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 18px;
      height: 18px;
      border-radius: 999px;
      background-color: #222;
      color: #fff;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
    }
  </style>
</head>

<body>
<header class="ks-header">
  <div class="ks-header-inner">
    <div class="ks-logo" onclick="location.href='index.html'">
      <span class="ks-logo-main">K-Shopping</span>
      <span class="ks-logo-sub">
        <span class="kor">ì™¸êµ­ì¸ì„ ìœ„í•œ ì „ë¬¸ ì‡¼í•‘ëª°</span> /
        <span class="eng">Global Shopping for Foreigners</span>
      </span>
    </div>

    <nav class="ks-nav"></nav>

    <div class="ks-actions">
      <button class="ks-icon-btn" type="button">
        <span onclick="goToAdmin()">ê´€ë¦¬ì / Admin</span>
        <span class="cart-label" onclick="goToCartPage()"> / ì¥ë°”êµ¬ë‹ˆ</span>
      </button>

      <div class="cart-icon-wrapper" onclick="goToCartPage()">
        <img src="https://cdn-icons-png.flaticon.com/512/34/34568.png" alt="Cart" />
        <span class="ks-cart-badge" id="headerCartCount">0</span>
      </div>
    </div>
  </div>
</header>
<div class="ks-header-spacer"></div>

<main>
  <h1>ì£¼ë¬¸ ì§„í–‰ì¤‘ / Order in Progress</h1>
  <p class="sub">
    ì•„ë˜ ì£¼ë¬¸ ë‚´ìš©ì„ í™•ì¸í•œ í›„, ì£¼ë¬¸ì ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.<br>
    Please review your order and fill in your information.
  </p>

  <section class="card" style="padding:0; border:none; background:transparent; box-shadow:none;">
    <div style="
      background:#e3f0ff;
      border-left:5px solid #1e6fff;
      padding:14px 16px;
      border-radius:10px;
      font-size:14px;
      color:#333;
      line-height:1.5;
    ">
      <div style="font-weight:600; margin-bottom:6px;">í•œêµ­ì–´ê°€ ì–´ë ¤ìš°ë©´ ì „í™”ë¡œ ì£¼ë¬¸í•˜ì„¸ìš”.</div>
      <div style="color:#444;">
        If Korean is difficult, please order by phone.
      </div>
      <div style="margin-top:10px; font-size:20px; font-weight:700; color:#1e6fff;">
        ğŸ“ ê³ ê°ì„¼í„° / Customer Service :
        <span id="csPhoneText">010-8640-8732</span>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="card-title">ì£¼ë¬¸ ìƒí’ˆ / Order Summary</div>
    <div id="orderSummaryArea" style="font-size:13px;"></div>
  </section>

  <section class="card" id="methodForm">
    <div class="card-title">ì£¼ë¬¸ì ì •ë³´ / Customer Information</div>

    <label>ì´ë¦„ / Name *</label>
    <input id="orderName" />

    <label>ì—°ë½ì²˜ / Phone *</label>
    <input id="orderPhone" />

    <label>ì£¼ì†Œ / Address *</label>
    <textarea id="orderAddress"></textarea>

    <label>ìš”ì²­ì‚¬í•­ / Memo</label>
    <textarea id="orderMemo"></textarea>
  </section>

  <section class="card">
    <div class="btn-row">
      <button type="button" class="btn-secondary" onclick="location.href='index.html'">
        â† ê³„ì† ì‡¼í•‘í•˜ê¸° / Continue Shopping
      </button>
      <button type="button" class="btn-primary" id="submitOrderBtn">
        ì£¼ë¬¸ ì ‘ìˆ˜ / Submit Order
      </button>
    </div>
  </section>
</main>

<!-- ğŸ”µ Supabase ì—°ë™ -->
<script type="module">
import { supabase } from "./js/supabaseClient.js";

function loadCart() {
  try {
    return JSON.parse(localStorage.getItem("cart")) || [];
  } catch (e) {
    return [];
  }
}

function renderOrderSummary() {
  const cart = loadCart();
  const area = document.getElementById("orderSummaryArea");

  if (!cart.length) {
    area.innerHTML = `<p style="color:#777;">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.</p>`;
    return;
  }

  let rows = "";
  let qtyTotal = 0;
  let subtotal = 0;

  cart.forEach((it) => {
    const price = it.priceSale || it.price;
    const line = price * it.qty;
    qtyTotal += it.qty;
    subtotal += line;

    rows += `
      <tr>
        <td>${it.name}</td>
        <td class="text-right">${it.qty}</td>
        <td class="text-right">${price.toLocaleString()}ì›</td>
        <td class="text-right">${line.toLocaleString()}ì›</td>
      </tr>
    `;
  });

  area.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>ìƒí’ˆëª…</th>
          <th class="text-right">ìˆ˜ëŸ‰</th>
          <th class="text-right">ê°€ê²©</th>
          <th class="text-right">í•©ê³„</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
    <div class="summary-footer">
      ì´ ìˆ˜ëŸ‰: <b>${qtyTotal}</b><br>
      ìƒí’ˆ í•©ê³„: <b>${subtotal.toLocaleString()}ì›</b>
    </div>
  `;
}

async function submitSupabaseOrder() {
  const cart = loadCart();
  if (!cart.length) {
    alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.");
    return;
  }

  const name = document.getElementById("orderName").value.trim();
  const phone = document.getElementById("orderPhone").value.trim();
  const address = document.getElementById("orderAddress").value.trim();
  const memo = document.getElementById("orderMemo").value.trim();

  if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
  if (!phone) return alert("ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  if (!address) return alert("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

  const orderId = "KS" + Date.now();
  const total_qty = cart.reduce((s, it) => s + it.qty, 0);
  const subtotal = cart.reduce((s, it) => s + (it.priceSale || it.price) * it.qty, 0);
  const total = subtotal;

  const { error } = await supabase.from("orders").insert([{
    id: orderId,
    name,
    phone,
    address,
    memo,
    items: cart,
    total_qty,
    subtotal,
    total
  }]);

  if (error) {
    console.error(error);
    alert("ì£¼ë¬¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    return;
  }

  localStorage.removeItem("cart");
  location.href = `order_complete.html?id=${orderId}`;
}

document.getElementById("submitOrderBtn").addEventListener("click", submitSupabaseOrder);

document.addEventListener("DOMContentLoaded", renderOrderSummary);
</script>

</body>
</html>


