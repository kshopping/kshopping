<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì£¼ë¬¸ ì •ë³´ ì…ë ¥</title>

  <link rel="stylesheet" href="css/order.css">
  <link rel="stylesheet" href="css/index.css">

  <style>
    #order-summary {
      background: #fff;
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      margin-bottom: 25px;
    }
    #order-summary h3 {
      margin-bottom: 12px;
      font-size: 20px;
      font-weight: 700;
    }
    .order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 15px;
    }
    .order-total {
      margin-top: 14px;
      font-size: 18px;
      font-weight: bold;
      text-align: right;
      color: #e74c3c;
    }
    .agree-box {
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 20px;
      font-size: 14px;
      border-radius: 8px;
      background: #fafafa;
    }
    .agree-box div {
      margin-bottom: 10px;
    }
    .agree-desc {
      margin-left: 22px;
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      line-height: 1.5;
    }
  </style>
</head>

<body>

<h2 class="title">ğŸ“¦ ì£¼ë¬¸ ì •ë³´ ì…ë ¥</h2>

<div class="order-box">

  <!-- ì£¼ë¬¸ ìƒí’ˆ ìš”ì•½ -->
  <div id="order-summary">
    <h3>ì£¼ë¬¸ ìƒí’ˆ ë‚´ì—­</h3>
    <div id="order-items"></div>
    <div class="order-total" id="order-total"></div>
  </div>

  <!-- ì£¼ë¬¸ ì…ë ¥ -->
  <div class="form-row">
    <label>ì´ë¦„</label>
    <input id="name" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
  </div>

  <div class="form-row">
    <label>ì—°ë½ì²˜</label>
    <input id="phone" type="text" placeholder="010-0000-0000">
  </div>

  <div class="form-row">
    <label>ì£¼ì†Œ</label>
    <input id="address" type="text" placeholder="ë°°ì†¡ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
  </div>

  <div class="form-row">
    <label>ìš”ì²­ì‚¬í•­</label>
    <textarea id="memo" placeholder="ìš”ì²­ì‚¬í•­ì´ ìˆë‹¤ë©´ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
  </div>

  <!-- âœ… ë¹„íšŒì› ì£¼ë¬¸ ë™ì˜ ì˜ì—­ -->
  <div class="agree-box">

    <!-- í•„ìˆ˜ -->
    <div>
      <label>
        <input type="checkbox" id="agree_required">
        <strong>[í•„ìˆ˜]</strong> ë¹„íšŒì› ì£¼ë¬¸ì— ë”°ë¥¸ ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.
      </label>
      <div class="agree-desc">
        ìˆ˜ì§‘ í•­ëª©: ì´ë¦„, íœ´ëŒ€ì „í™”ë²ˆí˜¸, ë°°ì†¡ì§€ ì£¼ì†Œ<br>
        ì´ìš© ëª©ì : ì£¼ë¬¸ ì²˜ë¦¬, ê²°ì œ, ë°°ì†¡ ë° ê³ ê° ë¬¸ì˜ ëŒ€ì‘<br>
        ë³´ìœ  ê¸°ê°„: ê´€ë ¨ ë²•ë ¹ì— ë”°ë¥¸ ë³´ê´€ ê¸°ê°„ í›„ íŒŒê¸°<br>
        <a href="/privacy.html" target="_blank">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ ë³´ê¸°</a>
      </div>
    </div>

    <!-- ì„ íƒ (ê´‘ê³ ) -->
    <div>
      <label>
        <input type="checkbox" id="agree_marketing">
        <strong>[ì„ íƒ]</strong> íœ´ëŒ€ì „í™”ë²ˆí˜¸ë¥¼ í†µí•œ K-Shopping ìƒí’ˆÂ·ì´ë²¤íŠ¸ ì•ˆë‚´ ìˆ˜ì‹ ì— ë™ì˜í•©ë‹ˆë‹¤.
      </label>
      <div class="agree-desc">
        ì „ì†¡ ë‚´ìš©: í• ì¸ ì •ë³´, ì‹ ìƒí’ˆ, ì´ë²¤íŠ¸ ì•ˆë‚´<br>
        ì „ì†¡ ìˆ˜ë‹¨: ë¬¸ì(SMS) ë˜ëŠ” ë©”ì‹ ì €<br>
        â€» ë™ì˜í•˜ì§€ ì•Šì•„ë„ ì£¼ë¬¸ì€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
      </div>
    </div>

  </div>

  <!-- ë²„íŠ¼ -->
  <button id="submitOrder" class="btn-order">âœ” ì£¼ë¬¸í•˜ê¸°</button>
  <button class="btn-back" onclick="location.href='index.html'">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>

</div>

<script type="module" src="./js/order.js"></script>

<script>
  function safeNumber(v, fallback = 0) {
    const n = Number(v);
    return isNaN(n) ? fallback : n;
  }

  function formatWon(n) {
    if (n === null || n === undefined || isNaN(n)) return "-";
    return Number(n).toLocaleString("ko-KR") + "ì›";
  }

  function isComputerItem(item) {
    const excludeCategories = ["ë…¸íŠ¸ë¶", "ì»´í“¨í„°", "ë°ìŠ¤í¬íƒ‘", "ì „ìê¸°ê¸°", "PC"];
    const excludeKeywords = [
      "ë…¸íŠ¸ë¶", "laptop", "notebook", "macbook",
      "hp", "lenovo", "asus", "dell", "msi", "acer",
      "ssd", "ram", "cpu", "i5", "i7", "i9", "ryzen",
      "ê·¸ë˜í”½", "gpu", "rtx", "gtx"
    ];

    const cat = (item?.category || "").toLowerCase();
    const name = (item?.name || "").toLowerCase();

    const matchCategory = excludeCategories.some(c => cat.includes(c.toLowerCase()));
    const matchKeyword = excludeKeywords.some(k => name.includes(k.toLowerCase()));

    return matchCategory || matchKeyword;
  }

  // âœ… ê³ ë‹ˆ ê·œì¹™ ì ìš©
  function calcBundlePrice(unitPrice, qty) {
    const ratio2 = 19900 / 13900;
    const ratio3 = 26900 / 13900;

    const u = safeNumber(unitPrice, 0);
    const q = Math.max(1, safeNumber(qty, 1));

    const price1 = Math.round(u);
    const price2 = Math.round(u * ratio2);
    const price3 = Math.round(u * ratio3);

    if (q === 1) return price1;
    if (q === 2) return price2;
    if (q === 3) return price3;

    const diff = price3 - price2;
    return price3 + (q - 3) * diff;
  }

  function recalcItemTotal(item) {
    const unitPrice = safeNumber(item.unitPrice ?? item.price ?? 0, 0);
    const qty = Math.max(1, safeNumber(item.qty ?? 1, 1));

    item.unitPrice = unitPrice;
    item.qty = qty;

    if (isComputerItem(item)) {
      item.bundleApplied = false;
      item.totalPrice = Math.round(unitPrice * qty);
    } else {
      item.bundleApplied = true;
      item.totalPrice = calcBundlePrice(unitPrice, qty);
    }
  }

  function loadOrderSummary() {
    const items = JSON.parse(localStorage.getItem("cartItems") || "[]");
    const area = document.getElementById("order-items");
    const totalArea = document.getElementById("order-total");

    if (!items.length) {
      area.innerHTML = "<p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</p>";
      totalArea.textContent = "";
      return;
    }

    // âœ… ë³´ì •
    items.forEach(item => {
      if (item.unitPrice === undefined) item.unitPrice = safeNumber(item.price ?? 0, 0);
      if (item.qty === undefined) item.qty = 1;
      if (item.totalPrice === undefined || safeNumber(item.totalPrice, 0) <= 0) {
        recalcItemTotal(item);
      }
    });
    localStorage.setItem("cartItems", JSON.stringify(items));

    let html = "";
    let total = 0;
    let qty = 0;

    items.forEach((item) => {
      const itemTotal = safeNumber(item.totalPrice ?? 0, 0);
      total += itemTotal;
      qty += safeNumber(item.qty, 0);

      const bundleText = isComputerItem(item) ? "ë¬¶ìŒ ì œì™¸" : "ë¬¶ìŒ ì ìš©";

      html += `
        <div class="order-item">
          <span>${item.name} x ${item.qty} <span style="font-size:12px; color:#888;">(${bundleText})</span></span>
          <span>${formatWon(itemTotal)}</span>
        </div>
      `;
    });

    area.innerHTML = html;
    totalArea.textContent = `ì´ ${qty}ê°œ | ì´ ê¸ˆì•¡: ${formatWon(total)}`;
  }

  loadOrderSummary();
</script>

</body>
</html>

